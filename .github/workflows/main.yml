name: Linux-RDP-Stable
on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-22.04  # Stable version use kar rahe hain
    steps:
      - name: Install Desktop (Zero Errors)
        run: |
          sudo apt update
          sudo DEBIAN_FRONTEND=noninteractive apt install -y xfce4 xfce4-goodies xrdp
          # XFCE ko default desktop set karna
          sudo sed -i 's/allowed_users=console/allowed_users=anybody/g' /etc/xrdp/Xwrapper.config
          echo "xfce4-session" > ~/.xsession
          sudo systemctl restart xrdp

      - name: Create RDP User
        run: |
          PASSWORD="Pass${{ github.run_id }}"
          sudo useradd -m RDP -s /bin/bash
          echo "RDP:$PASSWORD" | sudo chpasswd
          sudo usermod -aG sudo RDP
          echo "RDP_PASS=$PASSWORD" >> $GITHUB_ENV

      - name: Tailscale Connect
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          # Hostname fix: Linux variable format
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-linux-${{ github.run_id }}
          echo "TAILSCALE_IP=$(tailscale ip -4)" >> $GITHUB_ENV

      - name: Display Access Info
        run: |
          echo "IP: $TAILSCALE_IP"
          echo "User: RDP"
          echo "Pass: $RDP_PASS"
          while true; do sleep 300; done
