name: Strong-Windows-RDP
on: workflow_dispatch

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 3600  # 6 Hours Limit

    steps:
      - name: Optimize Windows & Enable RDP
        run: |
          # Disable background services to save RAM
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0

      - name: Create Strong User
        run: |
          $pass = "StrongPass@${{ github.run_id }}"
          net user RDP $pass /add
          net localgroup administrators RDP /add
          echo "PASSWORD=$pass" >> $env:GITHUB_ENV

      - name: Connect Tailscale
        run: |
          Invoke-WebRequest https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi -OutFile tailscale.msi
          msiexec.exe /i tailscale.msi /quiet
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=win-rdp-${{ github.run_id }}
          $ts_ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
          echo "IP=$ts_ip" >> $env:GITHUB_ENV

      - name: RDP Details & Keep Alive
        run: |
          echo "`n=== üñ•Ô∏è WINDOWS RDP READY ==="
          echo "IP: $env:IP"
          echo "User: RDP"
          echo "Pass: $env:PASSWORD"
          echo "===========================`n"
          # Loop to keep it alive for 6 hours
          while ($true) { Write-Host "RDP Active..."; Start-Sleep -Seconds 300 }
